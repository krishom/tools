<!doctype html>
<html>
  <head>
    <title>Safeway J4U Coupon Clipper</title>
    <style>
      body {
        font-family: arial, sans-serif;
      }
      img {
        box-shadow: 2px 2px 2px;
      }
    </style>
  </head>
  <body>
    <h3>Bookmarklet</h3>
    Drag this link to your bookmarks bar: <a href="javascript:!function(){var e,n,t,c,o,r,l,i,f,u='/foru/coupons-deals.html';window.location.href.indexOf(u)<0?window.location.replace('https://www.safeway.com'+u):(e={},n={},t=[],c=function(o){var e=curTop=0;if(o.offsetParent)for(;e+=o.offsetLeft,curTop+=o.offsetTop,o=o.offsetParent;);window.scrollTo&&window.scrollTo(e,curTop-150)},o=function(){i()>r()&&f()},r=function(){return Object.keys(n).length},i=function(){var e=0;return document.querySelectorAll('.grid-coupon-btn').forEach(o=>{'none'!=getComputedStyle(o).display&&(t.push(o),e++)}),console.warn('findActive',e,t),e},f=function(){var o=t.shift();o&&(e[o.id]?n[o.id]=!0:(console.warn('click',o),c(o),o.click(),e[o.id]=!0)),document.querySelectorAll('.btn-modal').forEach(o=>'Close'==o.innerText&&o.click()),t.length>r()?window.setTimeout(f,500):l()},(l=function(){console.warn('loadMore',t),document.querySelectorAll('.load-more').forEach(o=>{c(o),o.click()}),window.setTimeout(o,2e3)})())}();">Just4U</a>
    <br><br>
    Example:<br>
    <img src="bookmarklet.png">
    <h3>Instructions</h3>
    <ol>
      <li>Log in to the <a href="https://www.safeway.com/account/sign-in.html">safeway.com Coupon Center</a></li>
      <li>When the page loads, click the "Just4U" bookmarklet you created above.</li>
      <li>Each item will be added to your card sequentially.</li>
    </ol>
    <h3>Uncompiled Source</h3>
    <pre>
(function() {
  var url = '/foru/coupons-deals.html';
  if (window.location.href.indexOf(url) < 0) {
    window.location.replace('https://www.safeway.com' + url);
    return;
  }
  var clicked = {};
  var skipped = {};
  var toClick = [];
  var scrollToElement = function(el) {
    var curLeft = curTop = 0;
    if (el.offsetParent) {
      do {
        curLeft += el.offsetLeft;
        curTop += el.offsetTop;
      } while (el = el.offsetParent);
    }
    window.scrollTo && window.scrollTo(curLeft, curTop - 150);
  };
  var clickAllActive = function() {
    if (findActive() > skipCount()) {
      clickNext();
    }
  };
  var skipCount = function() {
    return Object.keys(skipped).length;
  }
  var loadMore = function() {
    console.warn('loadMore', toClick);
    document.querySelectorAll('.load-more').forEach(el => {
      scrollToElement(el);
      el.click();
    });
    window.setTimeout(clickAllActive, 2000);
  };
  var findActive = function() {
    var count = 0;
    document.querySelectorAll('.grid-coupon-btn').forEach(el => {
      if (getComputedStyle(el).display != 'none') {
        toClick.push(el);
        count++;
      }
    })
    console.warn('findActive', count, toClick);
    return count;
  };
  var clickNext = function() {
    var el = toClick.shift();
    if (el) {
      if (clicked[el.id]) {
        skipped[el.id] = true;
      } else {
        console.warn('click', el);
        scrollToElement(el);
        el.click()
        clicked[el.id] = true;
      }
    }
    document.querySelectorAll('.btn-modal').forEach(el => (el.innerText == 'Close') && el.click())
    if (toClick.length > skipCount()) {
      window.setTimeout(clickNext, 500);
    } else {
      loadMore();
    }
  };
  loadMore();
})();
    </pre>
  </body>
</html>
